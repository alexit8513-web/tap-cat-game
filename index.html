// –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let score = 0;
let money = 100;
let level = 1;
let clickPower = 1;
let autoClickPower = 0;
let autoClickInterval = null;

// –ë–∞–ª–∞–Ω—Å –∏–≥—Ä—ã
const gameBalance = {
    // –°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏–π (–ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è)
    clickUpgradeBaseCost: 50,
    autoClickBaseCost: 100,
    
    // –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
    levelRequirements: [0, 200, 500, 1000, 2000, 4000, 8000, 15000, 25000, 50000],
    
    // –ë–æ–Ω—É—Å—ã –∑–∞ —É—Ä–æ–≤–Ω–∏
    levelBonuses: [0, 50, 100, 200, 300, 500, 750, 1000, 1500, 2000]
};

// –¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏–π
let currentClickUpgradeCost = gameBalance.clickUpgradeBaseCost;
let currentAutoClickCost = gameBalance.autoClickBaseCost;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
let tg = window.Telegram.WebApp;
tg.expand();

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–∞–ø–∞
function tapCat() {
    // –î–æ–±–∞–≤–ª—è–µ–º –æ—á–∫–∏ –∏ –¥–µ–Ω—å–≥–∏
    score += clickPower;
    money += clickPower;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    updateUI();
    
    // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç —á–∞—Å—Ç–∏—Ü
    createParticle(`+${clickPower}`, '#ffd700');
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ—Ç–∞
    animateCat();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–≤–µ–Ω—å
    checkLevelUp();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    saveProgress();
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫—É–ø–∫–∏ —É–ª—É—á—à–µ–Ω–∏–π
function buyUpgrade(type) {
    if (type === 'click') {
        if (money >= currentClickUpgradeCost) {
            money -= currentClickUpgradeCost;
            clickPower += 1;
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è (–ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ)
            currentClickUpgradeCost = Math.floor(currentClickUpgradeCost * 1.8);
            
            updateUI();
            saveProgress();
            createParticle('üí™ +1 —Å–∏–ª–∞!', '#00ff00');
        } else {
            createParticle('‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥!', '#ff0000');
        }
    } else if (type === 'auto') {
        if (money >= currentAutoClickCost) {
            money -= currentAutoClickCost;
            autoClickPower += 1;
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–≤—Ç–æ–∫–ª–∏–∫–∞
            currentAutoClickCost = Math.floor(currentAutoClickCost * 2.2);
            
            startAutoClick();
            updateUI();
            saveProgress();
            createParticle('‚ö° –ê–≤—Ç–æ–∫–ª–∏–∫ +1!', '#00ffff');
        } else {
            createParticle('‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥!', '#ff0000');
        }
    }
}

// –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–∫–ª–∏–∫–µ—Ä–∞
function startAutoClick() {
    if (autoClickInterval) clearInterval(autoClickInterval);
    autoClickInterval = setInterval(() => {
        if (autoClickPower > 0) {
            score += autoClickPower;
            money += autoClickPower;
            updateUI();
            // –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã –¥–ª—è –∞–≤—Ç–æ–∫–ª–∏–∫–∞ (–º–µ–Ω–µ–µ –∑–∞–º–µ—Ç–Ω—ã–µ)
            if (Math.random() > 0.7) { // 30% —à–∞–Ω—Å –ø–æ–∫–∞–∑–∞—Ç—å —á–∞—Å—Ç–∏—Ü—É
                createParticle(`+${autoClickPower}`, '#00aa00');
            }
        }
    }, 1000);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
function updateUI() {
    document.getElementById('score').textContent = formatNumber(score);
    document.getElementById('money').textContent = formatNumber(money);
    document.getElementById('level').textContent = level;
    document.getElementById('power').textContent = clickPower;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–ª—É—á—à–µ–Ω–∏–π
    const clickBtn = document.querySelector('.shop-btn:nth-child(1)');
    const autoBtn = document.querySelector('.shop-btn:nth-child(2)');
    
    clickBtn.textContent = `üí™ –£—Å–∏–ª–∏—Ç–µ–ª—å (+1) - ${formatNumber(currentClickUpgradeCost)}üí∞`;
    autoBtn.textContent = `‚ö° –ê–≤—Ç–æ–∫–ª–∏–∫ (+1) - ${formatNumber(currentAutoClickCost)}üí∞`;
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥
    clickBtn.disabled = money < currentClickUpgradeCost;
    autoBtn.disabled = money < currentAutoClickCost;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
    updateLevelProgress();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —É—Ä–æ–≤–Ω—è
function updateLevelProgress() {
    const nextLevelScore = getNextLevelRequirement();
    const progress = nextLevelScore > 0 ? (score / nextLevelScore * 100) : 0;
    
    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    let progressBar = document.getElementById('levelProgress');
    if (!progressBar) {
        progressBar = document.createElement('div');
        progressBar.id = 'levelProgress';
        progressBar.style.width = '100%';
        progressBar.style.height = '5px';
        progressBar.style.background = 'rgba(255,255,255,0.3)';
        progressBar.style.borderRadius = '10px';
        progressBar.style.marginTop = '10px';
        progressBar.style.overflow = 'hidden';
        
        const progressFill = document.createElement('div');
        progressFill.id = 'levelProgressFill';
        progressFill.style.height = '100%';
        progressFill.style.background = 'linear-gradient(90deg, #ffd700, #ff6b00)';
        progressFill.style.transition = 'width 0.3s ease';
        progressBar.appendChild(progressFill);
        
        document.querySelector('.stats').appendChild(progressBar);
    }
    
    const progressFill = document.getElementById('levelProgressFill');
    progressFill.style.width = `${Math.min(progress, 100)}%`;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
function getNextLevelRequirement() {
    return level < gameBalance.levelRequirements.length ? gameBalance.levelRequirements[level] : 0;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª
function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    }
    if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

// –°–æ–∑–¥–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ —á–∞—Å—Ç–∏—Ü
function createParticle(text, color) {
    const effects = document.getElementById('effects');
    const particle = document.createElement('div');
    
    particle.className = 'particle';
    particle.textContent = text;
    particle.style.color = color;
    particle.style.left = Math.random() * 80 + 10 + '%';
    particle.style.top = '50%';
    particle.style.textShadow = '0 2px 10px rgba(0,0,0,0.5)';
    
    effects.appendChild(particle);
    
    // –£–¥–∞–ª—è–µ–º —á–∞—Å—Ç–∏—Ü—É –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
    setTimeout(() => {
        particle.remove();
    }, 1000);
}

// –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ—Ç–∞
function animateCat() {
    const cat = document.getElementById('cat');
    cat.style.transform = 'scale(0.95)';
    
    setTimeout(() => {
        cat.style.transform = 'scale(1)';
    }, 100);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è
function checkLevelUp() {
    const nextLevelScore = getNextLevelRequirement();
    if (nextLevelScore > 0 && score >= nextLevelScore) {
        levelUp();
    }
}

// –ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
function levelUp() {
    level++;
    
    // –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å –∑–∞ —É—Ä–æ–≤–µ–Ω—å
    const bonus = gameBalance.levelBonuses[level - 1] || 0;
    money += bonus;
    
    showLevelUp();
    updateUI();
    saveProgress();
}

// –ü–æ–∫–∞–∑ –∞–Ω–∏–º–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω—è
function showLevelUp() {
    const levelUp = document.createElement('div');
    levelUp.className = 'level-up';
    levelUp.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 10px;">üéâ</div>
            <div>–£—Ä–æ–≤–µ–Ω—å ${level}!</div>
            <div style="font-size: 16px; margin-top: 10px; color: #ffd700;">
                +${formatNumber(gameBalance.levelBonuses[level - 1] || 0)}üí∞ –±–æ–Ω—É—Å!
            </div>
        </div>
    `;
    
    document.body.appendChild(levelUp);
    
    setTimeout(() => {
        levelUp.remove();
    }, 3000);
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function saveProgress() {
    localStorage.setItem('tapCat_score', score);
    localStorage.setItem('tapCat_money', money);
    localStorage.setItem('tapCat_level', level);
    localStorage.setItem('tapCat_clickPower', clickPower);
    localStorage.setItem('tapCat_autoClickPower', autoClickPower);
    localStorage.setItem('tapCat_clickUpgradeCost', currentClickUpgradeCost);
    localStorage.setItem('tapCat_autoClickCost', currentAutoClickCost);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function loadProgress() {
    const savedScore = localStorage.getItem('tapCat_score');
    const savedMoney = localStorage.getItem('tapCat_money');
    const savedLevel = localStorage.getItem('tapCat_level');
    const savedClickPower = localStorage.getItem('tapCat_clickPower');
    const savedAutoClickPower = localStorage.getItem('tapCat_autoClickPower');
    const savedClickUpgradeCost = localStorage.getItem('tapCat_clickUpgradeCost');
    const savedAutoClickCost = localStorage.getItem('tapCat_autoClickCost');
    
    if (savedScore) score = parseInt(savedScore);
    if (savedMoney) money = parseInt(savedMoney);
    if (savedLevel) level = parseInt(savedLevel);
    if (savedClickPower) clickPower = parseInt(savedClickPower);
    if (savedAutoClickPower) {
        autoClickPower = parseInt(savedAutoClickPower);
        if (autoClickPower > 0) startAutoClick();
    }
    if (savedClickUpgradeCost) currentClickUpgradeCost = parseInt(savedClickUpgradeCost);
    if (savedAutoClickCost) currentAutoClickCost = parseInt(savedAutoClickCost);
    
    updateUI();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
document.addEventListener('DOMContentLoaded', () => {
    // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–æ—Ç–∞
    document.getElementById('cat').addEventListener('click', tapCat);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
    loadProgress();
    
    console.log('üê± –ò–≥—Ä–∞ Tap Cat –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
});
